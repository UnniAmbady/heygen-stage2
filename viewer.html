<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
    <title>AI Avatar Viewer (Direct WebRTC)</title>
    <style>
      html,body{margin:0;padding:0;height:100%;width:100%;background:#0b0b0c;color:#eaeaea;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
      .wrap{display:flex;flex-direction:column;gap:10px;width:100%;height:100%;align-items:center;justify-content:flex-start}
      .title{font-size:16px;text-align:center;margin-top:6px;opacity:.9}
      .stage{width:100%;max-width:420px;aspect-ratio:9/16;background:#111;border-radius:18px;overflow:hidden;border:1px solid #222;display:grid;place-items:center}
      video{width:100%;height:100%;object-fit:cover;display:block}
      .status{font-size:12px;opacity:.85}
      .log{width:100%;max-width:420px;background:#0f0f10;border:1px solid #1f1f22;border-radius:12px;padding:8px;font-size:12px;line-height:1.35;overflow:auto;max-height:220px}
      .muted{opacity:.7}
      .ok{color:#9fff9f}
      .warn{color:#ffd48a}
      .err{color:#ff9f9f}
      code{font-family:ui-monospace,SFMono-Regular,Consolas,Monaco,monospace; white-space:pre-wrap}
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="title">Avatar: <span id="aname"></span></div>
      <div class="stage"><video id="video" playsinline autoplay muted></video></div>
      <div class="status" id="status">initializing…</div>
      <div class="log" id="log"></div>
    </div>

    <script>
      // Injected by Streamlit
      const SESSION_TOKEN = "__SESSION_TOKEN__";
      const AVATAR_NAME   = "__AVATAR_NAME__";
      const SESSION_ID    = "__SESSION_ID__";
      const OFFER_SDP     = "__OFFER_SDP__"; // raw SDP text from streaming.new

      document.getElementById("aname").textContent = AVATAR_NAME;

      const statusEl = document.getElementById("status");
      const logEl = document.getElementById("log");
      const setStatus = (t)=> statusEl.textContent = t;
      const short = (s, n=10)=> (s||"").slice(0,n);
      function log(type, msg){
        const div = document.createElement("div");
        div.className = type;
        div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        logEl.appendChild(div);
        logEl.scrollTop = logEl.scrollHeight;
        (type==="err"?console.error:type==="warn"?console.warn:console.log)(msg);
      }

      log("muted", `sid="${short(SESSION_ID)}…", token="${short(SESSION_TOKEN,12)}…"`);

      // ---- DIRECT WEBRTC, NO SDK ----
      // 1) RTCPeerConnection with default STUN; HeyGen/LiveKit provides ICE in its SDP.
      const pc = new RTCPeerConnection();

      // Attach remote tracks
      const video = document.getElementById("video");
      pc.ontrack = (ev) => {
        const [stream] = ev.streams;
        if (stream) {
          video.srcObject = stream;
          video.muted = true;
          video.play().catch(()=>{});
          log("ok","ontrack — remote stream attached");
        }
      };

      pc.oniceconnectionstatechange = () => {
        log("muted", `iceConnectionState=${pc.iceConnectionState}`);
        if (pc.iceConnectionState === "connected" || pc.iceConnectionState === "completed") {
          setStatus("connected");
        } else if (pc.iceConnectionState === "failed" || pc.iceConnectionState === "disconnected") {
          setStatus("ice " + pc.iceConnectionState);
        }
      };

      pc.onsignalingstatechange = () => {
        log("muted", `signalingState=${pc.signalingState}`);
      };

      (async () => {
        try {
          setStatus("applying offer…");
          await pc.setRemoteDescription({ type: "offer", sdp: OFFER_SDP });
          log("ok","remote offer applied");

          setStatus("creating answer…");
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);

          // Wait for ICE gathering to complete so we send a full SDP
          await new Promise((resolve) => {
            if (pc.iceGatheringState === "complete") return resolve();
            const check = () => {
              if (pc.iceGatheringState === "complete") {
                pc.removeEventListener("icegatheringstatechange", check);
                resolve();
              }
            };
            pc.addEventListener("icegatheringstatechange", check);
            // safety timeout
            setTimeout(resolve, 1500);
          });

          setStatus("starting session…");
          const payload = {
            session_id: SESSION_ID,
            sdp: { type: "answer", sdp: pc.localDescription.sdp }
          };

          const res = await fetch("https://api.heygen.com/v1/streaming.start", {
            method: "POST",
            headers: {
              "Authorization": `Bearer ${SESSION_TOKEN}`,
              "Content-Type": "application/json",
              "accept": "application/json"
            },
            body: JSON.stringify(payload)
          });

          const text = await res.text();
          if (!res.ok) {
            log("err", `[start] ${res.status} ${text}`);
            setStatus("start failed");
            return;
          } else {
            log("ok", `[start] ${text.slice(0,120)}…`);
          }

          setStatus("waiting for media…");
          // A small grace period for first frames
          setTimeout(()=>log("muted","ready for tasks"), 500);

        } catch (err) {
          setStatus("init error");
          log("err", `init error: ${err?.message || err}`);
        }
      })();
    </script>
  </body>
</html>
